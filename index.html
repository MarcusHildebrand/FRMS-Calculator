<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHRS FRMS Calculator</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        /* --- CSS VARIABLES FOR THEMES --- */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --card-bg: white;
            --header-text: #0056b3;
            --border-color: #e9ecef;
            --input-bg: #fff;
            --input-border: #ccc;
            --input-text: #000;
            --accent-color: #007bff;
            --result-bg-green: #e8f5e9;
            --result-bg-white: #ffffff;
            --result-text: #1b5e20;
            --result-border: #c8e6c9;
        }
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --header-text: #6ea8fe;
            --border-color: #333;
            --input-bg: #2c2c2e;
            --input-border: #555;
            --input-text: #fff;
            --accent-color: #0d6efd;
            --result-bg-green: #0f2912;
            --result-bg-white: #1e1e1e;
            --result-text: #a5d6a7;
            --result-border: #2e7d32;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .status { color: #28a745; font-weight: bold; font-size: 0.9rem; }
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        h2 {
            margin-top: 0;
            color: var(--header-text);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        label {
            display: block;
            font-weight: bold;
            margin: 15px 0 5px;
            color: var(--text-color);
            opacity: 0.9;
        }
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .btn-toggle {
            flex: 1;
            min-width: 120px;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            color: var(--text-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-toggle:hover { border-color: var(--accent-color); }
        .btn-toggle.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .time-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .time-row > div { flex: 1; min-width: 280px; }
        input[type="time"] {
            padding: 12px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--input-text);
        }

        /* Safe Android-only fix for time input overflow */
        @media screen and (min-width: 0px) {
            _::-webkit-full-page-media, _:future, :root input[type="time"] {
                padding-right: 12px !important;
            }
        }

        .checkbox-container {
            background: var(--bg-color);
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            border-radius: 8px;
            margin-top: 25px;
            transition: background 0.2s;
        }
        .btn:hover { background: #0056b3; }
        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }
        .btn-secondary:hover { background: #545b62; }

        /* ODP Breakdown Button */
        .odp-breakdown-btn {
            background: #28a745;
            margin-top: 15px;
            padding: 12px;
            font-size: 16px;
        }
        .odp-breakdown-btn:hover { background: #218838; }

        /* Critical Times Display */
        .critical-times {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .critical-box {
            flex: 1;
            min-width: 220px;
            text-align: center;
        }
        .critical-label {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        .critical-value {
            font-size: 1.8rem;
            font-weight: bold;
            font-family: monospace;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--input-text);
        }
        /* Light red for Box 1 and Box 2 */
        #crit15hr, #critExtension {
            background: #ffebee !important;
            color: #c62828;
        }
        body.dark-mode #crit15hr,
        body.dark-mode #critExtension {
            background: #4a1c1c !important;
            color: #ff8a80;
        }
        /* Darker red for Box 3 (hard limit) */
        #crit16hr {
            background: #ef9a9a !important;
            color: #b71c1c;
        }
        body.dark-mode #crit16hr {
            background: #7f0000 !important;
            color: #ff5252;
        }

        .result-box {
            padding: 24px;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid var(--result-border);
            display: none;
            transition: background 0.3s ease;
        }
        .result-box.calculated {
            background: var(--result-bg-green);
            color: var(--result-text);
        }
        .result-box.stale {
            background: var(--result-bg-white);
            color: var(--text-color);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        body.dark-mode .error-message {
            background: #442b2d;
            color: #f5c2c7;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--result-border);
        }
        .result-row:last-child { border-bottom: none; }
        .result-val {
            font-weight: bold;
            font-family: monospace;
            font-size: 1.2rem;
        }
        .main-metric {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2e7d32;
        }
        body.dark-mode .main-metric { border-color: #4caf50; }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2e7d32;
        }
        body.dark-mode .metric-value { color: #4caf50; }
        .metric-note {
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 8px;
        }
        .placeholder {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        /* ODP Breakdown Modal */
        .odp-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .odp-modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .odp-modal h3 {
            margin-top: 0;
            color: var(--header-text);
        }
        .odp-breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .odp-breakdown-row:last-child { border-bottom: none; }
        .odp-breakdown-val {
            font-weight: bold;
            font-family: monospace;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover { color: var(--text-color); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1 style="margin:0; font-size:1.5rem;">WHRS FRMS Calculator</h1>
        <span class="status">‚úì System Online</span>
    </div>

    <div class="card">
        <h2>1. Shift Details</h2>
        <label>Operating Base</label>
        <div class="button-group">
            <button type="button" class="btn-toggle base-btn active" data-value="belmont">Belmont</button>
            <button type="button" class="btn-toggle base-btn" data-value="lismore">Lismore</button>
            <button type="button" class="btn-toggle base-btn" data-value="tamworth">Tamworth</button>
        </div>
        <label>Actual Shift Type</label>
        <div class="button-group">
            <button type="button" class="btn-toggle shift-btn active" data-shift="day">Day Shift</button>
            <button type="button" class="btn-toggle shift-btn" data-shift="night">Night Shift</button>
        </div>
        <div class="time-row">
            <div>
                <label for="start">FDP Commenced</label>
                <input type="time" id="start" required>
            </div>
            <div>
                <label for="end">FDP Completed</label>
                <input type="time" id="end" required>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>2. Adjustments</h2>
        <div class="time-row">
            <div>
                <label for="nfd">NFD (HH:mm)</label>
                <input type="time" id="nfd" value="01:00">
            </div>
            <div>
                <label for="rest">SDRP (HH:mm)</label>
                <input type="time" id="rest">
            </div>
        </div>
        <div class="checkbox-container">
            <label class="checkbox-label">
                <input type="checkbox" id="commute" checked>
                Commute to home required?
            </label>
        </div>
        <label>Theme Preference</label>
        <div class="button-group">
            <button type="button" class="btn-toggle theme-btn active" data-theme="light">‚òÄÔ∏è Light Mode</button>
            <button type="button" class="btn-toggle theme-btn" data-theme="dark">üåô Dark Mode</button>
        </div>
        <button class="btn" onclick="runLogic()">CALCULATE RESULTS</button>
        <button class="btn btn-secondary" onclick="resetForm()">RESET FORM</button>
    </div>

    <div class="card">
        <h2>3. Critical Times</h2>
        <div class="critical-times">
            <div class="critical-box">
                <div class="critical-label">15hr From Shift Start</div>
                <div class="critical-value" id="crit15hr">22:00</div>
            </div>
            <div class="critical-box">
                <div class="critical-label">Extension Required</div>
                <div class="critical-value" id="critExtension">--:--</div>
            </div>
            <div class="critical-box">
                <div class="critical-label">16hr Limit</div>
                <div class="critical-value" id="crit16hr">--:--</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>4. Calculated Results</h2>
        <div id="errorMessage" class="error-message"></div>
        <div id="resultsArea" class="result-box">
            <div class="main-metric">
                <span style="text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">Earliest Next Start</span>
                <span id="outNext" class="metric-value">--:--</span>
                <div id="outDay" class="metric-note"></div>
            </div>
            <div class="result-row"><span>Max FDP:</span> <span id="outMax" class="result-val">--:--</span></div>
            <div class="result-row"><span id="fdpLabel">FDP Extended:</span> <span id="outLimit" class="result-val">--:--</span></div>
            <div class="result-row"><span>FDP End Time:</span> <span id="outFdpEnd" class="result-val">--:--</span></div>
            <div class="result-row"><span>Exceedance:</span> <span id="outExc" class="result-val">--:--</span></div>
            <div class="result-row"><span>ODP (Hrs):</span> <span id="outODP" class="result-val">--:--</span></div>
            <button class="btn odp-breakdown-btn" id="odpBreakdownBtn" onclick="showODPBreakdown()" style="display:none;">Show ODP Calculation</button>
        </div>
        <div id="placeholder" class="placeholder">
            <em>Enter data above and press Calculate</em>
        </div>
    </div>
</div>

<!-- ODP Breakdown Modal -->
<div id="odpModal" class="odp-modal">
    <div class="odp-modal-content">
        <span class="close-modal" onclick="document.getElementById('odpModal').style.display='none'">&times;</span>
        <h3>ODP Calculation Breakdown</h3>
        <div id="odpBreakdownContent"></div>
    </div>
</div>

<script>
    const MINUTES_PER_DAY = 1440;
    const MAX_FDP_MINUTES = 960;
    const BASE_ODP = 480;  // 8 hours
    const BASE_ODP_COMMUTE = 600;  // 10 hours
    const LOCAL_NIGHT_START = 1380;  // 23:00
    const LOCAL_NIGHT_END = 359;  // 05:59

    // Nominal shift times
    const nominalStarts = {
        belmont:  { day: 420, night: 1140 },
        lismore:  { day: 420, night: 1140 },
        tamworth: { day: 480, night: 1200 }
    };

    let selectedBase = 'belmont';
    let selectedShift = 'day';
    let userHasEditedEnd = false;
    let resultsAreFresh = false;

    // Store last calculation details for breakdown
    let lastODPDetails = {};

    // Helpers
    const parseTime = (str) => str ? str.split(':').map(Number).reduce((h, m) => h * 60 + m, 0) : 0;
    const fmt = (mins) => {
        const h = String(Math.floor(mins / 60)).padStart(2, '0');
        const m = String(mins % 60).padStart(2, '0');
        return `${h}:${m}`;
    };
    const clock = (mins) => fmt(((mins % MINUTES_PER_DAY) + MINUTES_PER_DAY) % MINUTES_PER_DAY);

    // Detect if FDP overlaps local night (worked into it)
    function isFDPInLocalNight(start, end) {
        if (end < start) end += MINUTES_PER_DAY;
        const localStart = LOCAL_NIGHT_START;
        const localEnd = LOCAL_NIGHT_END + MINUTES_PER_DAY;  // Crosses midnight
        return start < localEnd && end > localStart;
    }

    // Mark results as stale
    function markResultsStale() {
        if (resultsAreFresh) {
            const resultsBox = document.getElementById('resultsArea');
            resultsBox.classList.remove('calculated');
            resultsBox.classList.add('stale');
            document.getElementById('odpBreakdownBtn').style.display = 'none';
            resultsAreFresh = false;
        }
    }

    // Show ODP breakdown modal
    function showODPBreakdown() {
        const content = document.getElementById('odpBreakdownContent');
        let html = `
            <div class="odp-breakdown-row"><span>Local Night Included in ODP:</span> <span class="odp-breakdown-val">${lastODPDetails.localNight ? 'Yes' : 'No'}</span></div>
            <div class="odp-breakdown-row"><span>Base ODP:</span> <span class="odp-breakdown-val">${fmt(lastODPDetails.base)}</span></div>
            <div class="odp-breakdown-row"><span>Over 12h Addition:</span> <span class="odp-breakdown-val">${fmt(lastODPDetails.over12)}</span></div>
        `;
        if (lastODPDetails.penalty > 0) {
            html += `<div class="odp-breakdown-row"><span>Extension Penalty:</span> <span class="odp-breakdown-val">${fmt(lastODPDetails.penalty)}</span></div>`;
            if (lastODPDetails.extensionBase8) {
                html += `<div class="odp-breakdown-row"><span>(Penalty applied to 8hr base due to local night)</span> <span></span></div>`;
            }
        }
        if (lastODPDetails.floorApplied) {
            html += `<div class="odp-breakdown-row"><span>Floor to 10h (commute):</span> <span class="odp-breakdown-val">Applied</span></div>`;
        }
        html += `<div class="odp-breakdown-row"><span><strong>Total ODP:</strong></span> <span class="odp-breakdown-val"><strong>${fmt(lastODPDetails.total)}</strong></span></div>`;
        content.innerHTML = html;
        document.getElementById('odpModal').style.display = 'flex';
    }

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('odpModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // SDRP validation
    function validateSDRP() {
        const restInput = document.getElementById('rest');
        const restVal = restInput.value;
        if (restVal) {
            const restMins = parseTime(restVal);
            if (restMins > 0 && restMins < 120) {
                alert("SDRP must be at least 2 hours (02:00) to qualify for extension.");
                restInput.value = '';
            }
        }
    }

    // Update Box 1
    function updateCritical15hr() {
        if (!selectedBase) return;
        const shiftStart = nominalStarts[selectedBase][selectedShift];
        const fifteenHoursLater = shiftStart + 900;
        document.getElementById('crit15hr').textContent = clock(fifteenHoursLater);
    }

    // Update Box 3
    function updateCritical16hr() {
        const startInput = document.getElementById('start').value;
        if (!startInput) {
            document.getElementById('crit16hr').textContent = '--:--';
            return;
        }
        const startMins = parseTime(startInput);
        const sixteenHoursLater = startMins + 960;
        document.getElementById('crit16hr').textContent = clock(sixteenHoursLater);
    }

    // Update Box 2
    function updateCriticalExtension() {
        const startInput = document.getElementById('start').value;
        if (!startInput) {
            document.getElementById('critExtension').textContent = '--:--';
            return;
        }
        const startMins = parseTime(startInput);
        const nfd = parseTime(document.getElementById('nfd').value);
        const rest = parseTime(document.getElementById('rest').value);

        let limitHours = 10;
        if (startMins >= 300 && startMins < 360) limitHours = 11;
        else if (startMins >= 360 && startMins < 420) limitHours = 11.5;
        else if (startMins >= 420 && startMins < 720) limitHours = 12;
        else if (startMins >= 720 && startMins < 900) limitHours = 11;
        else if (startMins >= 900 && startMins < 960) limitHours = 10.5;

        let fdpLimit = limitHours * 60 - nfd;
        if (rest >= 120) fdpLimit += rest;
        if (fdpLimit > MAX_FDP_MINUTES) fdpLimit = MAX_FDP_MINUTES;

        const extensionTime = startMins + fdpLimit;
        document.getElementById('critExtension').textContent = clock(extensionTime);
    }

    // Auto-fill FDP Completed
    function autoFillFdpCompleted() {
        if (userHasEditedEnd) return;

        const startInput = document.getElementById('start').value;
        if (!startInput) {
            document.getElementById('end').value = '';
            return;
        }
        const startMins = parseTime(startInput);
        const nfd = parseTime(document.getElementById('nfd').value);

        let limitHours = 10;
        if (startMins >= 300 && startMins < 360) limitHours = 11;
        else if (startMins >= 360 && startMins < 420) limitHours = 11.5;
        else if (startMins >= 420 && startMins < 720) limitHours = 12;
        else if (startMins >= 720 && startMins < 900) limitHours = 11;
        else if (startMins >= 900 && startMins < 960) limitHours = 10.5;

        const maxFdpMinutes = limitHours * 60;
        const projectedEnd = startMins + maxFdpMinutes - nfd;
        document.getElementById('end').value = clock(projectedEnd);
    }

    // Detect manual edit of FDP Completed
    document.getElementById('end').addEventListener('input', () => {
        userHasEditedEnd = true;
        markResultsStale();
    });

    // Base & Shift selection
    document.querySelectorAll('.base-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.base-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedBase = btn.dataset.value;
            updateCritical15hr();
            markResultsStale();
        });
    });

    document.querySelectorAll('.shift-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedShift = btn.dataset.shift;
            updateCritical15hr();
            markResultsStale();
        });
    });

    // Live updates
    const startInput = document.getElementById('start');
    startInput.addEventListener('input', () => {
        autoFillFdpCompleted();
        updateCritical16hr();
        updateCriticalExtension();
        markResultsStale();
    });
    startInput.addEventListener('change', () => {
        autoFillFdpCompleted();
        updateCritical16hr();
        updateCriticalExtension();
        markResultsStale();
    });

    document.getElementById('nfd').addEventListener('input', () => {
        autoFillFdpCompleted();
        updateCriticalExtension();
        markResultsStale();
    });
    document.getElementById('nfd').addEventListener('change', () => {
        autoFillFdpCompleted();
        updateCriticalExtension();
        markResultsStale();
    });

    const restInput = document.getElementById('rest');
    restInput.addEventListener('input', () => {
        validateSDRP();
        updateCriticalExtension();
        markResultsStale();
    });
    restInput.addEventListener('change', () => {
        validateSDRP();
        updateCriticalExtension();
        markResultsStale();
    });
    restInput.addEventListener('blur', validateSDRP);

    document.getElementById('commute').addEventListener('change', markResultsStale);

    // Theme toggle
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.body.classList.toggle('dark-mode', btn.dataset.theme === 'dark');
        });
    });

    function resetForm() {
        document.querySelectorAll('.base-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.base-btn[data-value="belmont"]').classList.add('active');
        selectedBase = 'belmont';

        document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.shift-btn[data-shift="day"]').classList.add('active');
        selectedShift = 'day';

        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.theme-btn[data-theme="light"]').classList.add('active');
        document.body.classList.remove('dark-mode');

        document.getElementById('start').value = '';
        document.getElementById('end').value = '';
        document.getElementById('nfd').value = '01:00';
        document.getElementById('rest').value = '';
        document.getElementById('commute').checked = true;

        userHasEditedEnd = false;
        resultsAreFresh = false;

        document.getElementById('resultsArea').style.display = 'none';
        document.getElementById('resultsArea').classList.remove('calculated', 'stale');
        document.getElementById('odpBreakdownBtn').style.display = 'none';
        document.getElementById('placeholder').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        updateCritical15hr();
        updateCritical16hr();
        updateCriticalExtension();
    }

    function runLogic() {
        document.getElementById('errorMessage').style.display = 'none';
        const baseBtn = document.querySelector('.base-btn.active');
        const base = baseBtn ? baseBtn.dataset.value : '';
        const startVal = document.getElementById('start').value;
        const endVal = document.getElementById('end').value;
        if (!base || !startVal || !endVal) {
            showError("Please select a Base and fill in FDP Commenced and FDP Completed.");
            return;
        }
        const start = parseTime(startVal);
        const end = parseTime(endVal);
        const nfd = parseTime(document.getElementById('nfd').value);
        const rest = parseTime(document.getElementById('rest').value);
        const commute = document.getElementById('commute').checked;

        let duration = end - start;
        if (duration <= 0) duration += MINUTES_PER_DAY;

        let limitHours = 10;
        if (start >= 300 && start < 360) limitHours = 11;
        else if (start >= 360 && start < 420) limitHours = 11.5;
        else if (start >= 420 && start < 720) limitHours = 12;
        else if (start >= 720 && start < 900) limitHours = 11;
        else if (start >= 900 && start < 960) limitHours = 10.5;

        const limitMinutes = limitHours * 60;
        let fdpLimit = limitMinutes - nfd;
        if (rest >= 120) fdpLimit += rest;
        if (fdpLimit > MAX_FDP_MINUTES) fdpLimit = MAX_FDP_MINUTES;

        const exceedance = Math.max(0, duration - fdpLimit);

        const halfRest = rest / 2;
        const over12 = Math.max(0, (duration - halfRest) - 720);

        // Local night detection: if FDP did not overlap local night
        const localNightIncluded = !isFDPInLocalNight(start, end);

        let calcODP;
        let details = {
            localNight: localNightIncluded,
            base: 0,
            over12: over12,
            penalty: 0,
            extensionBase8: false,
            floorApplied: false,
            total: 0
        };

        if (localNightIncluded) {
            // Case 1
            let baseODP = commute ? BASE_ODP_COMMUTE : BASE_ODP;
            calcODP = baseODP + over12;
            details.base = baseODP;

            if (exceedance > 0) {
                const penalty = Math.ceil(exceedance / 30) * 60;
                details.extensionBase8 = true;
                calcODP = BASE_ODP + over12 + penalty;  // 8hr base for penalty
                details.base = BASE_ODP;
                details.penalty = penalty;
            }

            // Floor if commute and <10h
            if (commute && calcODP < BASE_ODP_COMMUTE) {
                details.floorApplied = true;
                calcODP = BASE_ODP_COMMUTE;
            }
        } else {
            // Case 2
            calcODP = BASE_ODP_COMMUTE + over12;  // Always 10hr
            details.base = BASE_ODP_COMMUTE;

            if (exceedance > 0) {
                const penalty = Math.ceil(exceedance / 30) * 60;
                calcODP += penalty;
                details.penalty = penalty;
            }
        }

        details.total = calcODP;
        lastODPDetails = details;

        const totalODP = calcODP;
        const nextStart = end + totalODP;
        const projectedFdpEnd = start + fdpLimit;

        const fdpLabel = document.getElementById('fdpLabel');
        if (fdpLimit <= limitMinutes) {
            fdpLabel.textContent = 'FDP Remaining:';
        } else {
            fdpLabel.textContent = 'FDP Extended:';
        }

        document.getElementById('outMax').textContent = fmt(limitMinutes);
        document.getElementById('outLimit').textContent = fmt(fdpLimit);
        document.getElementById('outFdpEnd').textContent = clock(projectedFdpEnd);
        document.getElementById('outExc').textContent = exceedance === 0 ? '00:00' : fmt(exceedance);
        document.getElementById('outODP').textContent = fmt(totalODP);
        document.getElementById('outNext').textContent = clock(nextStart);
        document.getElementById('outDay').textContent = nextStart >= 2880 ? '(Two Days Later)' :
                                                    nextStart >= MINUTES_PER_DAY ? '(Next Day)' : '(Today)';

        const resultsBox = document.getElementById('resultsArea');
        resultsBox.classList.remove('stale');
        resultsBox.classList.add('calculated');
        resultsBox.style.display = 'block';
        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('odpBreakdownBtn').style.display = 'block';
        resultsAreFresh = true;
    }

    // Set defaults on page load
    window.onload = function() {
        document.querySelector('.base-btn[data-value="belmont"]').classList.add('active');
        document.querySelector('.shift-btn[data-shift="day"]').classList.add('active');
        document.querySelector('.theme-btn[data-theme="light"]').classList.add('active');
        document.getElementById('nfd').value = '01:00';
        document.getElementById('rest').value = '';
        selectedBase = 'belmont';
        selectedShift = 'day';
        userHasEditedEnd = false;
        resultsAreFresh = false;
        updateCritical15hr();
        updateCritical16hr();
        updateCriticalExtension();
    };
</script>
</body>
</html>